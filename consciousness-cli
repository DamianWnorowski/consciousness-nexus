#!/bin/bash
# ðŸ›¡ï¸ CONSCIOUSNESS CLI - Universal Command Line Interface
# =======================================================
#
# Call Consciousness Computing Suite from ANY environment:
# - Shell scripts
# - CI/CD pipelines
# - Docker containers
# - Cron jobs
# - Any programming language via system calls
# - AI coding assistants
# - Terminal sessions

set -e  # Exit on error

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="${SCRIPT_DIR}/.consciousness-cli.conf"
DEFAULT_API_URL="http://localhost:18473"
DEFAULT_API_KEY="consciousness-api-key-2024"

# Load configuration
if [[ -f "$CONFIG_FILE" ]]; then
    source "$CONFIG_FILE"
fi

# Default values
API_URL="${CONSCIOUSNESS_API_URL:-$DEFAULT_API_URL}"
API_KEY="${CONSCIOUSNESS_API_KEY:-$DEFAULT_API_KEY}"
TIMEOUT="${CONSCIOUSNESS_TIMEOUT:-30}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" >&2
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" >&2
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" >&2
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" >&2
}

# Make HTTP request to API
api_request() {
    local method="$1"
    local endpoint="$2"
    local data="$3"

    local headers=(
        -H "Content-Type: application/json"
        -H "X-API-Key: $API_KEY"
        --max-time "$TIMEOUT"
        --silent
        --show-error
    )

    if [[ -n "$data" ]]; then
        curl "${headers[@]}" -X "$method" "$API_URL$endpoint" -d "$data"
    else
        curl "${headers[@]}" -X "$method" "$API_URL$endpoint"
    fi
}

# Format JSON output
format_json() {
    if command -v jq &> /dev/null; then
        jq .
    else
        cat
    fi
}

# Show usage
usage() {
    cat << EOF
ðŸ›¡ï¸ CONSCIOUSNESS COMPUTING SUITE - UNIVERSAL CLI

Call enterprise AI safety and evolution from ANY environment!

USAGE:
    consciousness-cli [COMMAND] [OPTIONS]

COMMANDS:
    health              Check system health
    status              Get comprehensive system status
    login USER PASS     Authenticate and get session token
    logout SESSION      End session

    evolve OPERATION TARGET [PARAMS]
                        Run evolution operation
                        OPERATION: verified, recursive
                        TARGET: target system name
                        PARAMS: JSON parameters (optional)

    validate FILES...   Validate files
                        FILES: space-separated file paths

    analyze TYPE DATA   Run analysis
                        TYPE: fitness, performance, security
                        DATA: JSON data string

    custom METHOD ENDPOINT [DATA]
                        Make custom API request
                        METHOD: GET, POST, PUT, DELETE
                        ENDPOINT: API endpoint path
                        DATA: JSON data (optional)

OPTIONS:
    -u, --url URL       API server URL (default: $DEFAULT_API_URL)
    -k, --key KEY       API key (default: masked)
    -t, --timeout SEC   Request timeout in seconds (default: $TIMEOUT)
    -v, --verbose       Show detailed output
    -j, --json          Output raw JSON only
    -h, --help          Show this help

EXAMPLES:
    # Check if system is running
    consciousness-cli health

    # Run evolution with safety
    consciousness-cli evolve recursive my_project '{"max_iterations": 50}'

    # Validate Python files
    consciousness-cli validate src/main.py src/utils.py

    # Run fitness analysis
    consciousness-cli analyze fitness '{"cycles": 100, "fitness_score": 0.95}'

    # Custom API call
    consciousness-cli custom POST /evolution/run '{"operation_type": "verified", "target_system": "test"}'

    # Use in shell scripts
    if consciousness-cli health > /dev/null; then
        echo "Consciousness Suite is running"
    fi

    # CI/CD integration
    consciousness-cli validate src/ || exit 1

    # Call from any programming language
    result = system("consciousness-cli evolve verified my_app")
    json_data = parse_json(result)

ENVIRONMENT VARIABLES:
    CONSCIOUSNESS_API_URL     API server URL
    CONSCIOUSNESS_API_KEY     API key
    CONSCIOUSNESS_TIMEOUT     Request timeout

CONFIGURATION:
    Configuration can be stored in: $CONFIG_FILE
    Example:
        CONSCIOUSNESS_API_URL="https://api.consciousness-suite.com"
        CONSCIOUSNESS_API_KEY="your-api-key-here"
        CONSCIOUSNESS_TIMEOUT=60

For more information, visit: https://consciousness-suite.com/docs/cli

EOF
}

# Parse command line arguments
VERBOSE=false
JSON_ONLY=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -u|--url)
            API_URL="$2"
            shift 2
            ;;
        -k|--key)
            API_KEY="$2"
            shift 2
            ;;
        -t|--timeout)
            TIMEOUT="$2"
            shift 2
            ;;
        -v|--verbose)
            VERBOSE=true
            shift
            ;;
        -j|--json)
            JSON_ONLY=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            break
            ;;
    esac
done

# Main command processing
COMMAND="$1"
shift

if [[ -z "$COMMAND" ]]; then
    log_error "No command specified. Use --help for usage."
    exit 1
fi

# Execute command
case "$COMMAND" in
    health)
        if [[ "$JSON_ONLY" == "true" ]]; then
            api_request GET /health
        else
            log_info "Checking Consciousness Suite health..."
            response=$(api_request GET /health)
            if echo "$response" | grep -q '"status": "healthy"'; then
                log_success "Consciousness Suite is healthy and operational!"
                [[ "$VERBOSE" == "true" ]] && echo "$response" | format_json
            else
                log_error "Consciousness Suite health check failed"
                echo "$response" | format_json >&2
                exit 1
            fi
        fi
        ;;

    status)
        if [[ "$JSON_ONLY" == "true" ]]; then
            api_request GET /status
        else
            log_info "Getting system status..."
            response=$(api_request GET /status)
            echo "$response" | format_json
        fi
        ;;

    login)
        USERNAME="$1"
        PASSWORD="$2"
        if [[ -z "$USERNAME" || -z "$PASSWORD" ]]; then
            log_error "Usage: consciousness-cli login USERNAME PASSWORD"
            exit 1
        fi

        if [[ "$JSON_ONLY" == "true" ]]; then
            api_request POST /auth/login "{\"username\": \"$USERNAME\", \"password\": \"$PASSWORD\"}"
        else
            log_info "Authenticating user: $USERNAME"
            response=$(api_request POST /auth/login "{\"username\": \"$USERNAME\", \"password\": \"$PASSWORD\"}")

            if echo "$response" | grep -q '"success": true'; then
                session_id=$(echo "$response" | grep -o '"sessionId": "[^"]*' | cut -d'"' -f4)
                log_success "Authentication successful! Session: $session_id"
                [[ "$VERBOSE" == "true" ]] && echo "$response" | format_json
            else
                log_error "Authentication failed"
                echo "$response" | format_json >&2
                exit 1
            fi
        fi
        ;;

    evolve)
        OPERATION="$1"
        TARGET="$2"
        PARAMS="$3"

        if [[ -z "$OPERATION" || -z "$TARGET" ]]; then
            log_error "Usage: consciousness-cli evolve OPERATION TARGET [PARAMS]"
            exit 1
        fi

        # Build JSON payload
        json_data="{\"operation_type\": \"$OPERATION\", \"target_system\": \"$TARGET\""
        if [[ -n "$PARAMS" ]]; then
            json_data="$json_data, \"parameters\": $PARAMS"
        fi
        json_data="$json_data}"

        if [[ "$JSON_ONLY" == "true" ]]; then
            api_request POST /evolution/run "$json_data"
        else
            log_info "Running evolution: $OPERATION on $TARGET"
            [[ "$VERBOSE" == "true" ]] && log_info "Payload: $json_data"

            response=$(api_request POST /evolution/run "$json_data")

            if echo "$response" | grep -q '"success": true'; then
                log_success "Evolution completed successfully!"
                echo "$response" | format_json
            else
                log_error "Evolution failed"
                echo "$response" | format_json >&2
                exit 1
            fi
        fi
        ;;

    validate)
        if [[ $# -eq 0 ]]; then
            log_error "Usage: consciousness-cli validate FILES..."
            exit 1
        fi

        # Convert file list to JSON array
        files_json=$(printf '%s\n' "$@" | jq -R . | jq -s . 2>/dev/null || echo "[\"$*\"]")
        json_data="{\"files\": $files_json}"

        if [[ "$JSON_ONLY" == "true" ]]; then
            api_request POST /validation/run "$json_data"
        else
            log_info "Validating $# file(s)..."
            [[ "$VERBOSE" == "true" ]] && log_info "Payload: $json_data"

            response=$(api_request POST /validation/run "$json_data")

            if echo "$response" | grep -q '"success": true'; then
                log_success "Validation completed!"
                echo "$response" | format_json
            else
                log_error "Validation failed"
                echo "$response" | format_json >&2
                exit 1
            fi
        fi
        ;;

    analyze)
        TYPE="$1"
        DATA="$2"

        if [[ -z "$TYPE" || -z "$DATA" ]]; then
            log_error "Usage: consciousness-cli analyze TYPE DATA"
            exit 1
        fi

        json_data="{\"analysis_type\": \"$TYPE\", \"data\": $DATA}"

        if [[ "$JSON_ONLY" == "true" ]]; then
            api_request POST /analysis/run "$json_data"
        else
            log_info "Running $TYPE analysis..."
            [[ "$VERBOSE" == "true" ]] && log_info "Payload: $json_data"

            response=$(api_request POST /analysis/run "$json_data")

            if echo "$response" | grep -q '"success": true'; then
                log_success "Analysis completed!"
                echo "$response" | format_json
            else
                log_error "Analysis failed"
                echo "$response" | format_json >&2
                exit 1
            fi
        fi
        ;;

    custom)
        METHOD="$1"
        ENDPOINT="$2"
        DATA="$3"

        if [[ -z "$METHOD" || -z "$ENDPOINT" ]]; then
            log_error "Usage: consciousness-cli custom METHOD ENDPOINT [DATA]"
            exit 1
        fi

        if [[ "$JSON_ONLY" == "true" ]]; then
            api_request "$METHOD" "$ENDPOINT" "$DATA"
        else
            log_info "Making $METHOD request to $ENDPOINT..."
            [[ -n "$DATA" && "$VERBOSE" == "true" ]] && log_info "Payload: $DATA"

            response=$(api_request "$METHOD" "$ENDPOINT" "$DATA")
            echo "$response" | format_json
        fi
        ;;

    *)
        log_error "Unknown command: $COMMAND"
        log_info "Use --help for available commands"
        exit 1
        ;;
esac
